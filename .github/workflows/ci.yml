name: NixOS Configuration CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  check-flake:
    runs-on: ubuntu-latest
    env:
      NIX_PATH: nixpkgs=channel:nixos-unstable

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: nix-community
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true

      - name: Clean Nix store
        run: |
          nix store gc --print-roots
          nix-collect-garbage -d || true

      - name: Check flake metadata
        run: nix flake metadata

      - name: Check flake.lock
        run: |
          git diff --exit-code flake.lock || echo "Warning: flake.lock has uncommitted changes"

      - name: Evaluate all NixOS configurations
        run: |
          nix eval .#nixosConfigurations --apply "x: 'success'" 

      - name: Test package builds (dry-run)
        run: |
          nix build .#packages.x86_64-linux.default --dry-run --option keep-outputs true

