name: NixOS Configuration CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 512
          swap-size-mb: 1024
          remove-dotnet: "true"
          remove-android: "true"
          remove-haskell: "true"
          remove-codeql: "true"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Setup Cachix (optional - speeds up builds)
        uses: cachix/cachix-action@v15
        with:
          name: nix-community
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
        continue-on-error: true

      - name: Check Nix flake
        run: nix flake check --all-systems

      - name: Build NixOS configuration
        run: |
          # Build the system configuration (dry-run, won't actually install)
          nix build .#nixosConfigurations.nixos.config.system.build.toplevel --dry-run

          # Show what would be built
          nix build .#nixosConfigurations.nixos.config.system.build.toplevel --show-trace

      - name: Check for evaluation errors
        run: |
          nix eval .#nixosConfigurations.nixos.config.system.build.toplevel --apply 'x: "success"'

      - name: Validate flake.lock
        run: |
          nix flake metadata
          git diff --exit-code flake.lock || echo "Warning: flake.lock has uncommitted changes"
